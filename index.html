<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·»æ‰“å¡</title>
    <!-- å¼•å…¥ LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background-color: #f0f2f5;
            text-align: center;
        }
        #loading { display: none; color: #666; font-weight: bold; margin-top: 20px; }
        #resultArea { margin-top: 20px; padding: 15px; border-radius: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; }
        .status-success { color: #28a745; font-weight: bold; font-size: 1.2em; }
        .status-fail { color: #dc3545; font-weight: bold; font-size: 1.1em; }
        #pointsDisplay { margin-top: 15px; font-size: 1.1em; color: #333; }
    </style>
</head>
<body>

    <h2 style="color: #333;">ğŸŸ é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·» ğŸŸ</h2>

    <!-- æ–°çš„å–®ä¸€æŒ‰éˆ•å€åŸŸ -->
    <div class="button-container" style="margin-top: 30px;">
        <button id="mainBtn" style="background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; font-size: 20px; padding: 15px 30px; border-radius: 50px; border: none; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); width: 90%; max-width: 350px; cursor: pointer;">
            ğŸ“¸ é»æ“Šé¸æ“‡ç…§ç‰‡æˆ–æˆªåœ–
        </button>
        <!-- é€™è£¡ç§»é™¤äº† capture="environment" ä»¥å…è¨±é¸æ“‡ç›¸ç°¿ -->
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
    </div>

    <!-- è¦å‰‡èªªæ˜æ–‡å­— -->
    <div style="text-align: left; margin: 30px auto; color: #555; font-size: 15px; padding: 20px; background-color: #ffffff; border-radius: 15px; max-width: 350px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <p style="margin-bottom: 10px; font-weight: bold; font-size: 16px; text-align: center;">ğŸ“… æ‰“å¡è¦å‰‡èªªæ˜ï¼š</p>
        <ul style="padding-left: 20px; margin: 10px 0;">
            <li>è«‹æº–å‚™å¥½æ‚¨çš„é¢è†œç…§ç‰‡ã€‚</li>
            <li style="margin-top: 8px;">ç…§ç‰‡ä¸­é¢è†œä¸Šéœ€æœ‰<span style="color: #FF6B6B; font-weight: bold;">æ‰‹å¯«</span>ä»¥ä¸‹å…©è¡Œå­—ï¼š</li>
        </ul>
        <div style="text-align: center; background: #fff3e0; padding: 10px; border-radius: 8px; font-weight: bold; color: #d84315; margin: 10px 0;">
            #ä»Šæ—¥æ—¥æœŸ (ä¾‹å¦‚ 1/8)<br>
            #é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·»
        </div>
        <p style="margin-top: 10px; font-size: 13px; text-align: center;">(å¯ä»¥ä¸Šå‚³åŒ…å«ç…§ç‰‡çš„æˆªåœ–)</p>
    </div>

    <div id="loading">ğŸ”„ AI æ­£åœ¨åŠªåŠ›è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™...<br>(ç´„éœ€ 5-10 ç§’)</div>
    
    <div id="resultArea">
        <div id="statusText"></div>
        <div id="messageText" style="margin-top: 10px; color: #666;"></div>
        <div id="pointsDisplay"></div>
    </div>

    <script>
        // ğŸ”´ è¨­å®šå€ï¼šè«‹ç¢ºèªé€™è£¡å¡«çš„æ˜¯ä½ æ­£ç¢ºçš„è³‡è¨Š
        const LIFF_ID = "2008849214-ADiOsYy8";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbynBFRoWgGHVDC6wJ5Xi1Z8L7UBHS9d6JW3_P0zSgltexEpo0DygOUiPvo8G-eEKeNV/exec";

        // åˆå§‹åŒ– LIFF
        liff.init({ liffId: LIFF_ID }).then(() => {
            console.log("LIFF Initialized");
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }).catch(err => {
            alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF IDï¼š" + err);
        });

        // ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.getElementById('mainBtn').addEventListener('click', function() {
            document.getElementById('imageInput').click();
        });

        // ç¶å®šåœ–ç‰‡é¸æ“‡äº‹ä»¶
        document.getElementById('imageInput').addEventListener('change', function(e) {
            if (e.target.files.length === 0) return;
            const file = e.target.files[0];
            processAndUploadImage(file);
        });

        // è™•ç†ä¸¦ä¸Šå‚³åœ–ç‰‡
        function processAndUploadImage(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('mainBtn').disabled = true;
            document.getElementById('mainBtn').innerText = "è™•ç†ä¸­...";

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // ç°¡å–®å£“ç¸®é‚è¼¯ (é¿å…åœ–ç‰‡éå¤§å‚³è¼¸å¤±æ•—)
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 1024;
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½‰æˆ Base64 (JPEG, å“è³ª 0.7)
                    const base64Data = canvas.toDataURL('image/jpeg', 0.7);
                    sendToGoogleSheet(base64Data);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å‚³é€åˆ° Google Apps Script
        function sendToGoogleSheet(base64Data) {
            liff.getProfile().then(profile => {
                const payload = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    image: base64Data
                };

                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    showResult(data);
                })
                .catch(error => {
                    showResult({ status: "ERROR", message: "é€£ç·šå¤±æ•—ï¼š" + error });
                })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainBtn').disabled = false;
                    document.getElementById('mainBtn').innerText = "ğŸ“¸ é»æ“Šé¸æ“‡ç…§ç‰‡æˆ–æˆªåœ–";
                    document.getElementById('imageInput').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                });
            }).catch(err => {
                alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼š" + err);
                document.getElementById('loading').style.display = 'none';
            });
        }

        // é¡¯ç¤ºçµæœ
        function showResult(data) {
            const resultArea = document.getElementById('resultArea');
            const statusText = document.getElementById('statusText');
            const messageText = document.getElementById('messageText');
            const pointsDisplay = document.getElementById('pointsDisplay');

            resultArea.style.display = 'block';

            if (data.status === "SUCCESS") {
                statusText.innerHTML = '<span class="status-success">ğŸ‰ æ­å–œï¼æ‰“å¡æˆåŠŸï¼</span>';
                messageText.innerText = "å·²æˆåŠŸè¾¨è­˜ï¼š" + data.items;
                pointsDisplay.innerHTML = `ç›®å‰ç¸½ç©åˆ†ï¼š<span style="color: #FF6B6B; font-weight: bold;">${data.current.total}</span> é»`;
            } else if (data.status === "FAIL") {
                statusText.innerHTML = '<span class="status-fail">âš ï¸ æ‰“å¡å¤±æ•—</span>';
                messageText.innerText = "åŸå› ï¼š" + data.message;
                pointsDisplay.innerHTML = "";
            } else {
                statusText.innerHTML = '<span class="status-fail">âŒ ç³»çµ±éŒ¯èª¤</span>';
                messageText.innerText = data.message;
                pointsDisplay.innerHTML = "";
            }
        }
    </script>
</body>
</html>
