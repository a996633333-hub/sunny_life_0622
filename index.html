<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·»</title>
    <!-- å¼•å…¥ LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* å…¨åŸŸæ¨£å¼è¨­å®šï¼ŒèƒŒæ™¯æ”¹ç‚ºç±³é»ƒè‰² */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background-color: #FFFBE6; /* ç±³é»ƒè‰²èƒŒæ™¯ */
            text-align: center;
            color: #333;
            margin: 0;
        }

        /* --- å€‹äººè³‡æ–™å¡ç‰‡å€å¡Šæ¨£å¼ --- */
        .profile-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 30px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            margin: 20px auto 30px auto; /* ä¸Šä¸‹ç•™ç™½ */
            max-width: 400px;
        }

        .app-title {
            font-size: 22px;
            font-weight: bold;
            color: #D84315; /* æ·±æ©˜è‰²æ¨™é¡Œ */
            margin-bottom: 25px;
        }

        /* é ­åƒæ¨£å¼ (åœ“å½¢ + æ©˜è‰²é‚Šæ¡†) */
        #userAvatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #FF8E53;
            object-fit: cover; /* ç¢ºä¿åœ–ç‰‡ä¸è®Šå½¢ */
            margin-bottom: 15px;
            background-color: #eee; /* è¼‰å…¥å‰çš„ä½”ä½è‰² */
        }

        /* æš±ç¨±æ¨£å¼ */
        #userName {
            font-size: 20px;
            font-weight: bold;
            color: #D84315;
            margin-bottom: 20px;
        }

        .points-label {
            font-size: 16px;
            color: #888;
            margin-bottom: 5px;
        }

        /* è¶…å¤§é»æ•¸æ•¸å­—æ¨£å¼ */
        #userPoints {
            font-size: 90px; /* å­—é«”ç‰¹å¤§ */
            font-weight: 900;
            color: #FF9800; /* æ˜äº®æ©˜è‰² */
            line-height: 1;
            font-family: 'Arial Black', sans-serif; /* ä½¿ç”¨æ›´ç²—çš„å­—é«” */
        }

        .points-unit {
            font-size: 40px;
            font-weight: bold;
            color: #FF9800;
            display: block; /* è®“ã€Œé»ã€å­—æ›è¡Œé¡¯ç¤º */
            margin-top: 10px;
        }
        /* -------------------------------- */

        /* æŒ‰éˆ•æ¨£å¼ */
        .button-container { margin-top: 20px; margin-bottom: 30px; }
        #mainBtn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; font-size: 18px; padding: 14px 30px; border-radius: 50px; border: none; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); width: 85%; max-width: 320px; cursor: pointer; font-weight: bold;
        }
        
        /* V3 æ–°ç‰ˆè¦å‰‡æ¨£å¼ (æ›´é†’ç›®) */
        .rules-container { 
            text-align: left; 
            margin: 20px auto; 
            color: #333; 
            font-size: 14px; 
            padding: 20px 25px; 
            background-color: #fff3e0; /* æ·ºæ©˜è‰²èƒŒæ™¯ */
            border: 2px solid #FF8E53; /* æ·±æ©˜è‰²é‚Šæ¡† */
            border-radius: 15px; 
            max-width: 350px; 
        }

        /* å…¶ä»–æ¨£å¼ */
        #loading { display: none; color: #D84315; font-weight: bold; margin-top: 20px; font-size: 16px; }
        #resultArea { margin-top: 20px; padding: 20px; border-radius: 15px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; max-width: 350px; margin-left: auto; margin-right: auto; }
        .status-success { color: #28a745; font-weight: bold; font-size: 1.3em; }
        .status-fail { color: #dc3545; font-weight: bold; font-size: 1.2em; display: block; margin-bottom: 10px; }
        #messageText { font-size: 15px; line-height: 1.5; }
    </style>
</head>
<body>

    <!-- å€‹äººè³‡æ–™å¡ç‰‡å€å¡Š -->
    <div class="profile-card">
        <div class="app-title">ğŸŸ é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·» ğŸŸ</div>
        
        <!-- é ­åƒåœ–ç‰‡ -->
        <img id="userAvatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="User Avatar">
        
        <!-- ä½¿ç”¨è€…æš±ç¨± -->
        <div id="userName">è¼‰å…¥ä¸­...</div>
        
        <div class="points-label">ç›®å‰ç´¯ç©</div>
        
        <!-- å¤§æ•¸å­—é»æ•¸é¡¯ç¤º -->
        <div>
            <span id="userPoints">...</span>
            <span class="points-unit">é»</span>
        </div>
    </div>


    <!-- æ‰“å¡æŒ‰éˆ• -->
    <div class="button-container">
        <button id="mainBtn">ğŸ“¸ é»æ“Šä¸Šå‚³æˆªåœ–æ‰“å¡</button>
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
    </div>


    <!-- V3 æ–°ç‰ˆè¦å‰‡èªªæ˜ -->
    <div class="rules-container">
        <p style="margin-bottom: 15px; font-weight: bold; text-align: center; color: #D84315; font-size: 17px;">ğŸ“… V3 æœ€æ–°æ‰“å¡è¦å‰‡ï¼š</p>
        <ol style="padding-left: 20px; margin: 10px 0; color: #333; font-size: 15px; line-height: 1.6;">
            <li style="margin-bottom: 12px;">
                <span style="color: #D84315; font-weight: bold;">[é‡è¦] é™å®šç¤¾ç¾¤ï¼š</span><br>
                è«‹å‹™å¿…åœ¨<span style="background:#ffccbc; padding: 2px 6px; border-radius: 4px; font-weight: bold;">ã€Œé±¸é­šå§å§åŠ ç¢¼é€ğŸŸç¤¾ç¾¤ã€</span>å…§é€²è¡Œæ‰“å¡ã€‚
            </li>
            <li style="margin-bottom: 12px;">
                ç™¼é€æ–‡å­—ï¼šã€Œ#ä»Šæ—¥æ—¥æœŸã€+ã€Œ#é™ªé±¸é­šå§å§ä¸€èµ·ç·Šç·»ã€ã€‚
            </li>
            <li style="margin-bottom: 12px;">
                æ¥è‘—ç™¼é€ä¸€å¼µæœ‰ã€Œæ‰‹å¯«ä»Šæ—¥æ—¥æœŸã€çš„é¢è†œç…§ç‰‡ã€‚
            </li>
            <li>
                å°‡åŒ…å«<span style="color: #D84315; font-weight: bold;">ç¤¾ç¾¤æ¨™é¡Œ</span>ã€æ–‡å­—èˆ‡ç…§ç‰‡çš„å®Œæ•´ç•«é¢æˆªåœ–ä¸Šå‚³ã€‚
            </li>
        </ol>
        <p style="margin-top: 15px; font-size: 13px; text-align: center; color: #888; border-top: 1px dashed #FF8E53; padding-top: 10px;">
            (ç³»çµ±æœƒè‡ªå‹•è¾¨è­˜æ‚¨åœ¨è©²ç¤¾ç¾¤çš„æš±ç¨±å“¦ï¼)<br>
            (æ¯æ—¥é™æ‰“å¡æˆåŠŸä¸€æ¬¡)
        </p>
    </div>

    <!-- è¼‰å…¥èˆ‡çµæœé¡¯ç¤ºå€ -->
    <div id="loading">ğŸ”„ AI æ­£åœ¨å¯©æ ¸ç¤¾ç¾¤æˆªåœ–ä¸­...<br>(ç´„éœ€ 5-10 ç§’)</div>
    <div id="resultArea">
        <div id="statusText"></div>
        <div id="messageText" style="margin-top: 10px; color: #555;"></div>
    </div>

    <script>
        // ğŸ”´ è¨­å®šå€ï¼šè«‹ç¢ºèªé€™è£¡å¡«çš„æ˜¯ä½ æ­£ç¢ºçš„è³‡è¨Š
        const LIFF_ID = "2008849214-ADiOsYy8";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbynBFRoWgGHVDC6wJ5Xi1Z8L7UBHS9d6JW3_P0zSgltexEpo0DygOUiPvo8G-eEKeNV/exec";

        // åˆå§‹åŒ– LIFF
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                liff.getProfile().then(profile => {
                    document.getElementById('userAvatar').src = profile.pictureUrl;
                    document.getElementById('userName').innerText = profile.displayName;
                    fetchInitialPoints(profile.userId);
                }).catch(err => {
                    console.error("Profile Error:", err);
                    document.getElementById('userName').innerText = "ç„¡æ³•å–å¾—è³‡æ–™";
                    document.getElementById('userAvatar').src = "https://via.placeholder.com/100?text=Error";
                });
            }
        }).catch(err => {
            alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + err);
        });

        // æŸ¥è©¢åˆ†æ•¸å‡½å¼
        function fetchInitialPoints(userId) {
            const fetchUrl = `${GOOGLE_SCRIPT_URL}?action=getPoints&userId=${userId}`;
            fetch(fetchUrl)
                .then(response => response.json())
                .then(data => {
                    animateValue("userPoints", 0, data.total, 1000);
                })
                .catch(err => {
                    document.getElementById('userPoints').innerText = "?";
                });
        }

        // æ•¸å­—è·³å‹•å‹•ç•«
        function animateValue(id, start, end, duration) {
            if (start === end) {
                 document.getElementById(id).innerHTML = end;
                 return;
            }
            const range = end - start;
            let current = start;
            const increment = end > start? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        // ç¶å®šäº‹ä»¶
        document.getElementById('mainBtn').addEventListener('click', function() {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', function(e) {
            if (e.target.files.length === 0) return;
            processAndUploadImage(e.target.files[0]);
        });

        // è™•ç†ä¸¦ä¸Šå‚³
        function processAndUploadImage(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('mainBtn').disabled = true;
            document.getElementById('mainBtn').innerText = "è™•ç†ä¸­...";

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height; const maxWidth = 1024;
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const base64Data = canvas.toDataURL('image/jpeg', 0.7);
                    sendToGoogleSheet(base64Data);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å‚³é€åˆ°å¾Œç«¯
        function sendToGoogleSheet(base64Data) {
            liff.getProfile().then(profile => {
                const payload = { userId: profile.userId, displayName: profile.displayName, image: base64Data };
                fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(response => response.json())
                .then(data => {
                    showResult(data);
                    if (data.status === "SUCCESS") {
                        fetchInitialPoints(profile.userId); // æˆåŠŸå¾Œæ›´æ–°åˆ†æ•¸
                    }
                })
                .catch(error => { showResult({ status: "ERROR", message: "é€£ç·šå¤±æ•—ï¼š" + error }); })
                .finally(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainBtn').disabled = false;
                    document.getElementById('mainBtn').innerText = "ğŸ“¸ é»æ“Šä¸Šå‚³æˆªåœ–æ‰“å¡";
                    document.getElementById('imageInput').value = '';
                });
            });
        }

        // é¡¯ç¤ºçµæœ
        function showResult(data) {
            const resultArea = document.getElementById('resultArea');
            const statusText = document.getElementById('statusText');
            const messageText = document.getElementById('messageText');
            resultArea.style.display = 'block';
            
            // è‡ªå‹•æ²å‹•åˆ°çµæœå€
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            if (data.status === "SUCCESS") {
                statusText.innerHTML = '<span class="status-success">ğŸ‰ å¯©æ ¸é€šéï¼æ‰“å¡æˆåŠŸï¼</span>';
                messageText.innerHTML = "é»æ•¸å·²æ›´æ–°ï¼<br><span style='font-size:13px; color:#888'>(è«‹ç¢ºèªç¤¾ç¾¤æš±ç¨±æ˜¯å¦æ­£ç¢ºè¨˜éŒ„åœ¨å¾Œå°)</span>";
            } else if (data.status === "FAIL") {
                statusText.innerHTML = '<span class="status-fail">âš ï¸ æ‰“å¡å¤±æ•—</span>';
                messageText.innerText = data.message;
            } else {
                statusText.innerHTML = '<span class="status-fail">âŒ ç³»çµ±éŒ¯èª¤</span>';
                messageText.innerText = data.message;
            }
        }
    </script>
</body>
</html>
